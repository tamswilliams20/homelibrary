<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Manage your home library with ease">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Library">
    <title>Home Library Manager</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhvbWUgTGlicmFyeSBNYW5hZ2VyIiwKICAic2hvcnRfbmFtZSI6ICJMaWJyYXJ5IiwKICAiZGVzY3JpcHRpb24iOiAiTWFuYWdlIHlvdXIgaG9tZSBsaWJyYXJ5IHdpdGggZWFzZSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0RjQ2RTUiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhPVElpSUdobGFXZG9kRDBpTVRreUlpQjJhV1YzUW05NFBTSTFJQ0EwSURFNU1pQXhPVElpUGp4eVpXTjBJSGc5SWpBaUlIazlJakFpSUhkcFpIUm9QU0l4T1RJaUlHaGxhV2RvZEQwaU1Ua3lJaUJtYVd4c1BTSWpORVkwTmtVMUlpOCtQSEJoZEdnZ1pEMGlUVGsySURZMElFdzROQ0EyTkNCTU9EUWdPRFFnVERrMklEZzBJRXc1TmlBMk5FcE5OVFlnTVRJNElFdzBPQ0F4TWpnZ1REUTRJREUwTkNBc01USTRJRXcxTmlBeE5EUWdUalkwSURFME5DQk1OVFF0TWpBZ01USTRJRXcxTkMweU1DQXhNamhNTlRRZ09ESWdURFkyTFRJd0lEZ3lJRXcyTmlBeU5DQk1OVFFnTWpRZ1REVTBJRGd5ZWlJZ1ptbHNiRDBpSTJabVppSXZQand2YzNablBnPT0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-title h1 {
            font-size: 1.5rem;
            color: #1F2937;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4F46E5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338CA;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-secondary {
            background: #6B7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4B5563;
        }
        
        .form-group {
            background: #F9FAFB;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        input, select {
            padding: 0.625rem;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 0.875rem;
            width: 100%;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .search-filter {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .search-wrapper {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-wrapper input {
            padding-left: 2.5rem;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
        }
        
        .age-filter {
            min-width: 150px;
        }
        
        .empty-state {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 3rem;
            text-align: center;
        }
        
        .empty-state h3 {
            color: #6B7280;
            margin: 1rem 0 0.5rem;
        }
        
        .empty-state p {
            color: #9CA3AF;
        }
        
        .age-group {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .age-group h2 {
            color: #1F2937;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .book-card {
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
        }
        
        .book-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .book-content {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .book-cover {
            width: 64px;
            height: 96px;
            object-fit: cover;
            border-radius: 4px;
            background: #F3F4F6;
        }
        
        .book-info {
            flex: 1;
            min-width: 0;
        }
        
        .book-title {
            font-weight: 600;
            color: #1F2937;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .book-author {
            font-size: 0.875rem;
            color: #6B7280;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 0.25rem;
        }
        
        .book-location {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #4F46E5;
        }
        
        .book-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-edit, .btn-delete {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        .btn-edit:hover {
            background: #BFDBFE;
        }
        
        .btn-delete {
            background: #FEE2E2;
            color: #991B1B;
        }
        
        .btn-delete:hover {
            background: #FECACA;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 1.5rem;
            color: #1F2937;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-field {
            margin-bottom: 1rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        @media (max-width: 640px) {
            .header-title h1 {
                font-size: 1.25rem;
            }
            
            .books-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .icon {
            width: 20px;
            height: 20px;
        }
        
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            padding: 1rem;
        }
        
        .scanner-modal.active {
            display: flex;
            flex-direction: column;
        }
        
        .scanner-header {
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scanner-header h2 {
            color: white;
            font-size: 1.25rem;
        }
        
        .close-scanner {
            background: #EF4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        #reader {
            flex: 1;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .menu-button {
            background: #6B7280;
            color: white;
            border: none;
            padding: 0.625rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .menu-button:hover {
            background: #4B5563;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-content button {
            color: #1F2937;
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            text-align: left;
        }
        
        .dropdown-content button:hover {
            background-color: #F3F4F6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="header-title">
                    <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4 6h2v12H4V6zm4 0h2v12H8V6zm4 0h6v12h-6V6zm8 0h2v12h-2V6z"/>
                    </svg>
                    <h1>Home Library Manager</h1>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="openScanner()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                        </svg>
                        Scan Barcode
                    </button>
                    <button class="btn btn-success" onclick="openManualEntry()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Manual Entry
                    </button>
                    <button class="btn btn-primary" onclick="toggleIsbnForm()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add by ISBN
                    </button>
                    <div class="dropdown">
                        <button class="menu-button" onclick="toggleMenu()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                            Menu
                        </button>
                        <div id="menuDropdown" class="dropdown-content">
                            <button onclick="exportToCSV()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Export to CSV
                            </button>
                            <button onclick="backupData()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                                </svg>
                                Backup Data
                            </button>
                            <button onclick="document.getElementById('restoreInput').click()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                Restore Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="isbnForm" class="form-group" style="display: none;">
                <label>Enter ISBN (10 or 13 digits)</label>
                <div class="input-group">
                    <input type="text" id="isbnInput" placeholder="e.g., 9780439708180">
                    <button class="btn btn-success" onclick="fetchBook()">
                        <span id="fetchText">Fetch Book</span>
                    </button>
                </div>
            </div>
            
            <div class="search-filter">
                <div class="search-wrapper">
                    <svg class="search-icon icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search by title or author..." onkeyup="filterBooks()">
                </div>
                <select id="ageFilter" class="age-filter" onchange="filterBooks()">
                    <option value="all">All Ages</option>
                    <option value="0-2">Age 0-2</option>
                    <option value="2-4">Age 2-4</option>
                    <option value="4-6">Age 4-6</option>
                    <option value="6-8">Age 6-8</option>
                    <option value="8-12">Age 8-12</option>
                    <option value="12+">Age 12+</option>
                </select>
            </div>
        </div>
        
        <div id="booksList"></div>
    </div>
    
    <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreData(event)">
    
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-header">
            <h2>Scan Book Barcode</h2>
            <button class="close-scanner" onclick="closeScanner()">Close</button>
        </div>
        <div id="reader"></div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Book Details</h2>
            <div class="form-field">
                <label>Title</label>
                <input type="text" id="editTitle">
            </div>
            <div class="form-field">
                <label>Author</label>
                <input type="text" id="editAuthor">
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label>Bookcase</label>
                    <input type="text" id="editBookcase" placeholder="e.g., A, 1, Living Room">
                </div>
                <div class="form-field">
                    <label>Shelf Number</label>
                    <input type="text" id="editShelf" placeholder="e.g., 1, 2, Top">
                </div>
            </div>
            <div class="form-field">
                <label>Age Range</label>
                <select id="editAgeRange">
                    <option value="0-2">0-2 years</option>
                    <option value="2-4">2-4 years</option>
                    <option value="4-6">4-6 years</option>
                    <option value="6-8">6-8 years</option>
                    <option value="8-12">8-12 years</option>
                    <option value="12+">12+ years</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveBook()">Save Book</button>
            </div>
        </div>
    </div>

    <script>
        let books = [];
        let editingBookId = null;
        let html5QrCode = null;
        
        // Load books from localStorage
        function loadBooks() {
            const saved = localStorage.getItem('libraryBooks');
            if (saved) {
                books = JSON.parse(saved);
            }
            renderBooks();
        }
        
        // Save books to localStorage
        function saveBooks() {
            localStorage.setItem('libraryBooks', JSON.stringify(books));
        }
        
        function toggleMenu() {
            document.getElementById('menuDropdown').classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.menu-button') && !event.target.matches('.menu-button *')) {
                const dropdowns = document.getElementsByClassName('dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].classList.remove('show');
                }
            }
        }
        
        // Barcode Scanner Functions
        function openScanner() {
            document.getElementById('scannerModal').classList.add('active');
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanError
            ).catch(err => {
                alert('Unable to access camera. Please check permissions or use manual ISBN entry.');
                closeScanner();
            });
        }
        
        function onScanSuccess(decodedText) {
            closeScanner();
            document.getElementById('isbnInput').value = decodedText;
            fetchBook();
        }
        
        function onScanError(errorMessage) {
            // Ignore scan errors (they happen frequently while scanning)
        }
        
        function closeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerModal').classList.remove('active');
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                    document.getElementById('scannerModal').classList.remove('active');
                });
            } else {
                document.getElementById('scannerModal').classList.remove('active');
            }
        }
        
        // Export to CSV
        function exportToCSV() {
            toggleMenu();
            
            if (books.length === 0) {
                alert('No books to export!');
                return;
            }
            
            const headers = ['Title', 'Author', 'ISBN', 'Age Range', 'Bookcase', 'Shelf'];
            const csvContent = [
                headers.join(','),
                ...books.map(book => [
                    `"${book.title}"`,
                    `"${book.author}"`,
                    `"${book.isbn || ''}"`,
                    `"${book.ageRange}"`,
                    `"${book.bookcase}"`,
                    `"${book.shelf}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `library_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Library exported successfully!');
        }
        
        // Backup Data
        function backupData() {
            toggleMenu();
            
            if (books.length === 0) {
                alert('No books to backup!');
                return;
            }
            
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                books: books
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `library_backup_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Backup created successfully!');
        }
        
        // Restore Data
        function restoreData(event) {
            toggleMenu();
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (backup.books && Array.isArray(backup.books)) {
                        if (confirm(`This will restore ${backup.books.length} books. Current data will be replaced. Continue?`)) {
                            books = backup.books;
                            saveBooks();
                            renderBooks();
                            alert('Data restored successfully!');
                        }
                    } else {
                        alert('Invalid backup file format.');
                    }
                } catch (error) {
                    alert('Error reading backup file. Please make sure it is a valid backup file.');
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        function toggleIsbnForm() {
            const form = document.getElementById('isbnForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        async function fetchBook() {
            const isbn = document.getElementById('isbnInput').value.trim();
            if (!isbn) return;
            
            const fetchText = document.getElementById('fetchText');
            fetchText.textContent = 'Searching...';
            
            try {
                const cleanIsbn = isbn.replace(/[^0-9X]/gi, '');
                
                // Try Google Books API
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const book = data.items[0].volumeInfo;
                    openEditModal({
                        id: Date.now(),
                        isbn: cleanIsbn,
                        title: book.title || '',
                        author: book.authors ? book.authors.join(', ') : '',
                        cover: book.imageLinks?.thumbnail || '',
                        ageRange: determineAgeRange(book.categories || [], book.title || ''),
                        bookcase: '',
                        shelf: ''
                    });
                    document.getElementById('isbnInput').value = '';
                    toggleIsbnForm();
                } else {
                    if (confirm('Book not found in database. Would you like to enter the book details manually?')) {
                        openManualEntry();
                        document.getElementById('isbnInput').value = '';
                        toggleIsbnForm();
                    }
                }
            } catch (error) {
                alert('Error connecting to book database. Please try manual entry.');
            }
            
            fetchText.textContent = 'Fetch Book';
        }
        
        function determineAgeRange(subjects, title) {
            const text = [...subjects, title].join(' ').toLowerCase();
            
            if (text.includes('board book') || text.includes('baby') || text.includes('infant')) {
                return '0-2';
            } else if (text.includes('toddler') || text.includes('preschool')) {
                return '2-4';
            } else if (text.includes('kindergarten') || text.includes('early reader')) {
                return '4-6';
            } else if (text.includes('chapter book') || text.includes('middle grade')) {
                return '8-12';
            } else if (text.includes('young adult') || text.includes('teen')) {
                return '12+';
            }
            return '6-8';
        }
        
        function openManualEntry() {
            openEditModal({
                id: Date.now(),
                isbn: '',
                title: '',
                author: '',
                cover: '',
                ageRange: '6-8',
                bookcase: '',
                shelf: ''
            });
        }
        
        function openEditModal(book) {
            editingBookId = book.id;
            document.getElementById('modalTitle').textContent = books.find(b => b.id === book.id) ? 'Edit Book' : 'Add Book Details';
            document.getElementById('editTitle').value = book.title || '';
            document.getElementById('editAuthor').value = book.author || '';
            document.getElementById('editBookcase').value = book.bookcase || '';
            document.getElementById('editShelf').value = book.shelf || '';
            document.getElementById('editAgeRange').value = book.ageRange || '6-8';
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            editingBookId = null;
        }
        
        function saveBook() {
            const title = document.getElementById('editTitle').value.trim();
            const bookcase = document.getElementById('editBookcase').value.trim();
            const shelf = document.getElementById('editShelf').value.trim();
            
            if (!title || !bookcase || !shelf) {
                alert('Please fill in all required fields (Title, Bookcase, Shelf)');
                return;
            }
            
            const book = {
                id: editingBookId,
                title: title,
                author: document.getElementById('editAuthor').value.trim(),
                bookcase: bookcase,
                shelf: shelf,
                ageRange: document.getElementById('editAgeRange').value,
                cover: books.find(b => b.id === editingBookId)?.cover || ''
            };
            
            const existingIndex = books.findIndex(b => b.id === editingBookId);
            if (existingIndex >= 0) {
                books[existingIndex] = book;
            } else {
                books.push(book);
            }
            
            saveBooks();
            renderBooks();
            closeModal();
        }
        
        function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                books = books.filter(b => b.id !== id);
                saveBooks();
                renderBooks();
            }
        }
        
        function filterBooks() {
            renderBooks();
        }
        
        function renderBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const ageFilter = document.getElementById('ageFilter').value;
            
            const filtered = books.filter(book => {
                const matchesSearch = book.title.toLowerCase().includes(searchTerm) || 
                                    book.author.toLowerCase().includes(searchTerm);
                const matchesAge = ageFilter === 'all' || book.ageRange === ageFilter;
                return matchesSearch && matchesAge;
            });
            
            const booksList = document.getElementById('booksList');
            
            if (filtered.length === 0) {
                booksList.innerHTML = `
                    <div class="empty-state">
                        <svg style="width: 64px; height: 64px; color: #D1D5DB; margin: 0 auto;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 6h2v12H4V6zm4 0h2v12H8V6zm4 0h6v12h-6V6zm8 0h2v12h-2V6z"/>
                        </svg>
                        <h3>No books yet</h3>
                        <p>Add your first book by clicking the buttons above</p>
                    </div>
                `;
                return;
            }
            
            const grouped = {};
            filtered.forEach(book => {
                if (!grouped[book.ageRange]) {
                    grouped[book.ageRange] = [];
                }
                grouped[book.ageRange].push(book);
            });
            
            const ageRanges = ['0-2', '2-4', '4-6', '6-8', '8-12', '12+'];
            let html = '';
            
            ageRanges.forEach(range => {
                if (grouped[range]) {
                    html += `
                        <div class="age-group">
                            <h2>
                                <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.5 4.5c-1.95 0-4.05 1.73-5.5 3.5-1.45-1.77-3.55-3.5-5.5-3.5-2.89 0-5.5 2.21-5.5 6.04 0 3.65 2.79 6.62 6.97 10.38l2.03 1.82 2.03-1.82C16.21 17.16 19 14.19 19 10.54c0-3.83-2.61-6.04-5.5-6.04z"/>
                                </svg>
                                Age ${range} years (${grouped[range].length} books)
                            </h2>
                            <div class="books-grid">
                                ${grouped[range].map(book => `
                                    <div class="book-card">
                                        <div class="book-content">
                                            ${book.cover ? `<img src="${book.cover}" alt="${book.title}" class="book-cover">` : '<div class="book-cover"></div>'}
                                            <div class="book-info">
                                                <div class="book-title">${book.title}</div>
                                                <div class="book-author">${book.author}</div>
                                                ${book.bookcase ? `
                                                    <div class="book-location">
                                                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        </svg>
                                                        <span>Case ${book.bookcase}, Shelf ${book.shelf}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="book-actions">
                                            <button class="btn-edit" onclick='openEditModal(${JSON.stringify(book)})'>
                                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                                Edit
                                            </button>
                                            <button class="btn-delete" onclick="deleteBook(${book.id})">
                                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });